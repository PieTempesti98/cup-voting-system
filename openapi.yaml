openapi: 3.0.3
info:
  title: CUP Voting System API
  description: |
    REST API for the CUP (Consiglio di Unit√† Pastorale) Voting System.

    This API manages electoral counting for parish elections, including:
    - Candidate management across different parishes and age groups
    - Ballot registration with real-time validation
    - Vote counting and results tracking
    - Data persistence and audit trails

    **Authentication**: Currently not implemented in the spec, but recommended for production.

    **Voting Rules**:
    - Santo Stefano: max 3 votes per age group
    - San Pio X: max 2 votes per age group
    - Immacolata ai Passi: max 1 vote per age group

    **Age Groups**: 18-35, 36-60, 61+
  version: 1.0.0
  contact:
    name: CUP System Support
    email: support@cup-system.example
  license:
    name: Unlicensed

servers:
  - url: http://localhost:3000/api/v1
    description: Local development server
  - url: https://api.cup-voting.example/v1
    description: Production server

tags:
  - name: Candidates
    description: Candidate management operations
  - name: Ballots
    description: Ballot registration and management
  - name: Results
    description: Vote counting and results
  - name: System
    description: System configuration and health

paths:
  # ==================== CANDIDATES ====================

  /candidates:
    get:
      tags:
        - Candidates
      summary: Get all candidates
      description: Retrieve the complete list of candidates, optionally filtered by parish and/or age group
      operationId: getCandidates
      parameters:
        - name: parrocchia
          in: query
          description: Filter by parish name
          required: false
          schema:
            type: string
            enum: [Santo Stefano, San Pio X, Immacolata ai Passi]
        - name: fasciaEta
          in: query
          description: Filter by age group
          required: false
          schema:
            type: string
            enum: ['18-35', '36-60', '61+']
      responses:
        '200':
          description: List of candidates retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Candidate'
                  count:
                    type: integer
                    example: 15
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Candidates
      summary: Add a new candidate
      description: Create a new candidate in the system
      operationId: createCandidate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CandidateInput'
      responses:
        '201':
          description: Candidate created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Candidate'
                  message:
                    type: string
                    example: Candidate created successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Conflict - Candidate already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /candidates/{candidateId}:
    get:
      tags:
        - Candidates
      summary: Get candidate by ID
      description: Retrieve details of a specific candidate
      operationId: getCandidateById
      parameters:
        - $ref: '#/components/parameters/CandidateId'
      responses:
        '200':
          description: Candidate retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Candidate'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    put:
      tags:
        - Candidates
      summary: Update candidate
      description: Update an existing candidate's information
      operationId: updateCandidate
      parameters:
        - $ref: '#/components/parameters/CandidateId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CandidateInput'
      responses:
        '200':
          description: Candidate updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Candidate'
                  message:
                    type: string
                    example: Candidate updated successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Candidates
      summary: Delete candidate
      description: Remove a candidate from the system (only allowed if no votes recorded)
      operationId: deleteCandidate
      parameters:
        - $ref: '#/components/parameters/CandidateId'
      responses:
        '200':
          description: Candidate deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Candidate deleted successfully
        '400':
          description: Cannot delete - candidate has votes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ==================== BALLOTS ====================

  /ballots:
    get:
      tags:
        - Ballots
      summary: Get all ballots
      description: Retrieve all registered ballots with optional filtering
      operationId: getBallots
      parameters:
        - name: tipo
          in: query
          description: Filter by ballot type
          required: false
          schema:
            type: string
            enum: [valida, nulla, bianca]
        - name: limit
          in: query
          description: Number of results to return
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
        - name: offset
          in: query
          description: Number of results to skip (for pagination)
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        '200':
          description: Ballots retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Ballot'
                  count:
                    type: integer
                    example: 150
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

    post:
      tags:
        - Ballots
      summary: Register a new ballot
      description: |
        Submit a new ballot for registration. The ballot will be validated according to voting rules:
        - Check vote limits per parish and age group
        - Determine if ballot is valid, invalid (nulla), or blank (bianca)
        - Update vote counts for valid ballots
      operationId: createBallot
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BallotInput'
      responses:
        '201':
          description: Ballot registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Ballot'
                  validation:
                    $ref: '#/components/schemas/BallotValidation'
                  message:
                    type: string
                    example: Ballot registered successfully
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /ballots/{ballotId}:
    get:
      tags:
        - Ballots
      summary: Get ballot by ID
      description: Retrieve details of a specific ballot
      operationId: getBallotById
      parameters:
        - $ref: '#/components/parameters/BallotId'
      responses:
        '200':
          description: Ballot retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Ballot'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

    delete:
      tags:
        - Ballots
      summary: Delete/cancel a ballot
      description: Cancel a previously registered ballot (audit trail maintained)
      operationId: deleteBallot
      parameters:
        - $ref: '#/components/parameters/BallotId'
      responses:
        '200':
          description: Ballot cancelled successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Ballot cancelled successfully
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /ballots/validate:
    post:
      tags:
        - Ballots
      summary: Validate ballot without registering
      description: Check if a ballot would be valid according to voting rules without actually registering it
      operationId: validateBallot
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                votes:
                  type: object
                  additionalProperties:
                    type: boolean
                  description: Map of candidate IDs to vote selection
                  example:
                    "123": true
                    "124": true
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BallotValidation'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /ballots/summary:
    get:
      tags:
        - Ballots
      summary: Get ballot statistics
      description: Retrieve summary statistics of all ballots
      operationId: getBallotSummary
      responses:
        '200':
          description: Summary retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      total:
                        type: integer
                        example: 150
                      valide:
                        type: integer
                        example: 142
                      nulle:
                        type: integer
                        example: 5
                      bianche:
                        type: integer
                        example: 3
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ==================== RESULTS ====================

  /results:
    get:
      tags:
        - Results
      summary: Get voting results
      description: Retrieve complete voting results with vote counts per candidate
      operationId: getResults
      parameters:
        - name: parrocchia
          in: query
          description: Filter results by parish
          required: false
          schema:
            type: string
            enum: [Santo Stefano, San Pio X, Immacolata ai Passi]
        - name: fasciaEta
          in: query
          description: Filter results by age group
          required: false
          schema:
            type: string
            enum: ['18-35', '36-60', '61+']
        - name: sortBy
          in: query
          description: Sort results by field
          required: false
          schema:
            type: string
            enum: [voti, nome]
            default: voti
        - name: order
          in: query
          description: Sort order
          required: false
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: Results retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/CandidateResult'
                  summary:
                    type: object
                    properties:
                      totalVotes:
                        type: integer
                        example: 450
                      validBallots:
                        type: integer
                        example: 142
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /results/export:
    get:
      tags:
        - Results
      summary: Export results to CSV
      description: Download complete voting results as CSV file
      operationId: exportResults
      parameters:
        - name: format
          in: query
          description: Export format
          required: false
          schema:
            type: string
            enum: [csv, json, pdf]
            default: csv
      responses:
        '200':
          description: Export file generated successfully
          content:
            text/csv:
              schema:
                type: string
                format: binary
            application/json:
              schema:
                type: object
            application/pdf:
              schema:
                type: string
                format: binary
        '500':
          $ref: '#/components/responses/InternalServerError'

  # ==================== SYSTEM ====================

  /system/config:
    get:
      tags:
        - System
      summary: Get system configuration
      description: Retrieve voting rules and system configuration
      operationId: getSystemConfig
      responses:
        '200':
          description: Configuration retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemConfig'
        '500':
          $ref: '#/components/responses/InternalServerError'

  /system/health:
    get:
      tags:
        - System
      summary: Health check
      description: Check if the API is running and database is accessible
      operationId: healthCheck
      responses:
        '200':
          description: System is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time
                  version:
                    type: string
                    example: 1.0.0
                  database:
                    type: string
                    enum: [connected, disconnected]
                    example: connected
        '503':
          description: Service unavailable
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: error
                  message:
                    type: string
                    example: Database connection failed

  /system/reset:
    post:
      tags:
        - System
      summary: Reset all data
      description: |
        **DANGER**: Delete all candidates, ballots, and results.
        This operation cannot be undone. Should be protected by authentication.
      operationId: resetSystem
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                confirm:
                  type: string
                  description: Must be "RESET" to confirm
                  example: RESET
              required:
                - confirm
      responses:
        '200':
          description: System reset successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: All data has been deleted
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          $ref: '#/components/responses/InternalServerError'

# ==================== COMPONENTS ====================

components:
  schemas:
    Candidate:
      type: object
      required:
        - id
        - nome
        - parrocchia
        - fasciaEta
        - createdAt
      properties:
        id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        nome:
          type: string
          minLength: 1
          maxLength: 100
          example: Mario Rossi
        parrocchia:
          type: string
          enum: [Santo Stefano, San Pio X, Immacolata ai Passi]
          example: Santo Stefano
        fasciaEta:
          type: string
          enum: ['18-35', '36-60', '61+']
          example: '36-60'
        createdAt:
          type: string
          format: date-time
          example: '2024-01-15T10:30:00Z'
        updatedAt:
          type: string
          format: date-time
          example: '2024-01-15T10:30:00Z'

    CandidateInput:
      type: object
      required:
        - nome
        - parrocchia
        - fasciaEta
      properties:
        nome:
          type: string
          minLength: 1
          maxLength: 100
          example: Mario Rossi
        parrocchia:
          type: string
          enum: [Santo Stefano, San Pio X, Immacolata ai Passi]
          example: Santo Stefano
        fasciaEta:
          type: string
          enum: ['18-35', '36-60', '61+']
          example: '36-60'

    Ballot:
      type: object
      required:
        - id
        - tipo
        - timestamp
      properties:
        id:
          type: string
          format: uuid
          example: 660e8400-e29b-41d4-a716-446655440001
        tipo:
          type: string
          enum: [valida, nulla, bianca]
          example: valida
        timestamp:
          type: string
          format: date-time
          example: '2024-01-15T14:30:00Z'
        votes:
          type: object
          additionalProperties:
            type: boolean
          description: Map of candidate IDs to vote selection
          example:
            "550e8400-e29b-41d4-a716-446655440000": true
            "550e8400-e29b-41d4-a716-446655440001": true
        cancelled:
          type: boolean
          default: false
          example: false
        cancelledAt:
          type: string
          format: date-time
          nullable: true

    BallotInput:
      type: object
      required:
        - votes
      properties:
        votes:
          type: object
          additionalProperties:
            type: boolean
          description: Map of candidate IDs to vote selection
          example:
            "550e8400-e29b-41d4-a716-446655440000": true
            "550e8400-e29b-41d4-a716-446655440001": true
        tipo:
          type: string
          enum: [bianca]
          description: Optional - set to 'bianca' to explicitly register a blank ballot

    BallotValidation:
      type: object
      properties:
        valida:
          type: boolean
          example: true
        tipo:
          type: string
          enum: [valida, nulla, bianca]
          example: valida
        errors:
          type: array
          items:
            type: object
            properties:
              parrocchia:
                type: string
                example: Santo Stefano
              fasciaEta:
                type: string
                example: '36-60'
              votes:
                type: integer
                example: 4
              limit:
                type: integer
                example: 3
              message:
                type: string
                example: Too many votes for Santo Stefano 36-60 (4/3)
        votesByCategory:
          type: object
          description: Vote count per parish-ageGroup combination
          example:
            "Santo Stefano-18-35": 2
            "Santo Stefano-36-60": 1

    CandidateResult:
      allOf:
        - $ref: '#/components/schemas/Candidate'
        - type: object
          properties:
            voti:
              type: integer
              minimum: 0
              example: 45
            percentuale:
              type: number
              format: float
              minimum: 0
              maximum: 100
              example: 31.7

    SystemConfig:
      type: object
      properties:
        parrocchie:
          type: array
          items:
            type: string
          example: [Santo Stefano, San Pio X, Immacolata ai Passi]
        fasceEta:
          type: array
          items:
            type: string
          example: ['18-35', '36-60', '61+']
        limitiVoti:
          type: object
          additionalProperties:
            type: integer
          example:
            "Santo Stefano": 3
            "San Pio X": 2
            "Immacolata ai Passi": 1
        version:
          type: string
          example: 1.0.0

    Pagination:
      type: object
      properties:
        limit:
          type: integer
          example: 100
        offset:
          type: integer
          example: 0
        total:
          type: integer
          example: 150
        hasMore:
          type: boolean
          example: true

    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          example: BAD_REQUEST
        message:
          type: string
          example: Invalid input data
        details:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
                example: nome
              message:
                type: string
                example: Name is required
        timestamp:
          type: string
          format: date-time
          example: '2024-01-15T14:30:00Z'

  parameters:
    CandidateId:
      name: candidateId
      in: path
      required: true
      description: Unique identifier of the candidate
      schema:
        type: string
        format: uuid

    BallotId:
      name: ballotId
      in: path
      required: true
      description: Unique identifier of the ballot
      schema:
        type: string
        format: uuid

  responses:
    BadRequest:
      description: Bad request - Invalid input
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: NOT_FOUND
            message: Resource not found
            timestamp: '2024-01-15T14:30:00Z'

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: INTERNAL_SERVER_ERROR
            message: An unexpected error occurred
            timestamp: '2024-01-15T14:30:00Z'

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT authentication (not currently implemented)

# Security can be applied globally or per-operation
# security:
#   - BearerAuth: []
